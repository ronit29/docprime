{% extends 'doctor/base.html' %}

{% block content %} 
<div ng-app="appMaps" class="container">

  <div id="map_canvas" ng-controller="mainCtrl" class="row">
  <script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyCxzOncSHC1FRfKCTYCAnjOctzsMjMtxj0"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/lodash.js/4.0.1/lodash.js" type="text/javascript"></script>
  <script src="https://ajax.googleapis.com/ajax/libs/angularjs/1.4.8/angular.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/angular-simple-logger/0.1.7/angular-simple-logger.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/angular-google-maps/2.4.1/angular-google-maps.min.js"></script>
  <script type="text/javascript">
      var url = window.location.search;
url = url.replace("?", '');
<!--console.log(url);-->
LocFac =  "/api/v1/doctor/record_api?" + url;

angular.module('appMaps', ['uiGmapgoogle-maps'])
  .config(function($interpolateProvider) {
         $interpolateProvider.startSymbol('[');
         $interpolateProvider.endSymbol(']');
  })

  .controller('mainCtrl', function($scope, $http, uiGmapGoogleMapApi, uiGmapIsReady) {
      $scope.user_location = []
      $scope.new_map ={}
      $scope.map = {
        zoom:14,
        bounds: {},
        center: { latitude: 28.4485, longitude: 77.0759 }
      };


       var polygonData = [
            {lat:28.445642, lng:77.033551},
            {lat:28.448288, lng:77.021452},
            {lat:28.435727, lng:77.010201},
            {lat:28.455029, lng:76.991727},
            {lat:28.458546, lng:76.964193},
            {lat:28.472674, lng:76.962541},
            {lat:28.489109, lng:77.019593},
            {lat:28.485445, lng:77.019684},
            {lat:28.462055, lng:77.032061},
            {lat:28.452296, lng:77.041535}
            ]
      $scope.markers = [];
      $scope.new_markers = [];

        <!--var newPolygon = new google.maps.Polygon({-->
            <!--paths:polygonData,-->
            <!--strokeColor:'#FF0000',-->
            <!--strokeOpactiy:0.8,-->
            <!--storkeWeight:3,-->
            <!--fillColor:'#FF0000',-->
            <!--fillOpacity:0.35-->
        <!--})-->
        <!--newPolygon.setMap($scope.new_map);-->

      $http.get(LocFac).then(function(data) {
          var markers = data.data.map_data;
          var labels  = data.data.labels;

          angular.forEach(markers, function (marker) {

             marker.coords = {
                latitude: marker.latitude,
                longitude: marker.longitude
             }
             marker.options= {icon: marker.image, label: marker.label};
          })

          $scope.labels = labels;
          $scope.markers = markers;

          $scope.tabClick =  function(id){ //tabs_click
          $scope.new_markers =  markers.filter((x=>x.label == id));
             if($scope.new_markers.length > 0){
                  $scope.markers = $scope.new_markers;
             }else{
                  $scope.markers = markers;
             }
          }

          $scope.multiSelect = function(){
            var abc = []
            var entered_val = [];
            if($scope.multi_select){
                entered_val = $scope.multi_select.split(",")

                if(entered_val.length){
                 entered_val.forEach(myFunction);
                    function myFunction(value, index, array) {
                      abc = abc.concat(markers.filter((x=>x.label == value)))
                    }
                  $scope.markers = abc;
                }
            }else{
                alert('please enter some value')
            }
         }

    <!--console.log($scope.markers)-->
          $scope.detectLocation = function () { //detect location
              if (navigator.geolocation) {
                  navigator.geolocation.getCurrentPosition((position) => {

                  $scope.user_location = position;
                  $scope.location_data();
                  }, (a, b, c) => {
                      alert('Could not fetch location.')
                  }, (a, b, c) => {

                      alert('Could not fetch location.')
                  })
              }
              else {

              }
          }

          $scope.submitHandler = function(){
             console.log($scope.user_lat);
             console.log($scope.user_long);
             if($scope.user_long && $scope.user_lat){
                 markers.coords = {
                    latitude: $scope.user_lat,
                    longitude: $scope.user_long
                 }
                 $scope.user_location = markers;
                 $scope.location_data();
             }else{
                if(!$scope.user_long){
                    alert('enter valid longitutde')
                }else if(!$scope.user_lat){
                    alert('enter valid latitude')
                }
             }
         }

          $scope.location_data = function (){ //after detecting location fetch new results

          <!--var new_url = url.replace("?", '');-->

          var new_url = "/api/v1/doctor/record_api?" + url.replace("?", '');
          if($scope.user_location && $scope.user_location.coords){

            new_url += '&lat='+ $scope.user_location.coords.latitude
            new_url += '&long='+ $scope.user_location.coords.longitude
            $scope.new_map = {
                zoom:14,
                bounds: {},
                center: { latitude: $scope.user_location.coords.latitude, longitude: $scope.user_location.coords.longitude }
                <!--center: { latitude: 12.972442, longitude: 77.580643 }-->
              }
              $scope.map = $scope.new_map;
           }
           <!--console.log($scope.map)-->
           <!--console.log(new_url);-->
              $http.get(new_url).then(function(data) {
                  var markers = data.data.map_data;

                  var existing_merkers ={
                            latitude: $scope.user_location.coords.latitude,
                            longitude: $scope.user_location.coords.longitude,
                            image:'https://cdn.docprime.com/media/web/custom_images/man-user_1.png',
                            coords:{latitude: $scope.user_location.coords.latitude, longitude: $scope.user_location.coords.longitude},
                            address: "",
                            combined_rating: 0,
                            combined_rating_count: 0,
                            created_at: "",
                            has_booking: 0,
                            has_phone: 0,
                            hospital_name: "",
                            id: 1215000,
                            is_bookable: 1,
                            is_potential: 1,
                            lead_rank: " ",
                            location: "SRID=4326;POINT (77.062023 28.438662)",
                            monday_timing: " ",
                            multi_speciality: "",
                            place_id: "",
                            reason: "",
                            text: "current user",
                            updated_at: ""}
                  markers.push(existing_merkers)
                  var labels  = data.data.labels;

                  angular.forEach(markers, function (marker) {

                     marker.coords = {
                        latitude: marker.latitude,
                        longitude: marker.longitude
                     }
                     marker.options= {icon: marker.image, label: marker.label};
                  })

                  $scope.labels = labels;
                  $scope.markers = markers;

                  $scope.tabClick =  function(id){ //tabs_click
                  $scope.new_markers =  markers.filter((x=>x.label == id));
                     if($scope.new_markers.length > 0){
                          $scope.markers = $scope.new_markers;
                     }else{
                          $scope.markers = markers;
                     }
                  }
               })
          }
       });
    });
  </script>

 <style>
 .angular-google-map-container {
       min-height: 500px;
       width: auto;
  }
.mb-5{
margin-bottom:10px;
}
  </style>
      <div class="text-center mb-5">
        <button class="btn btn-success" ng-click="detectLocation()">locate me</button>
        </div>
      <div class="container container-fluid">
          <div class="row">
          <div class="col-md-6 mb-5">
          lat: <input type="text" name="lat" class="form-control"   value="" ng-model="user_lat">
          </div>
          <div class="col-md-6 mb-5">
            long: <input type="text" class="form-control" name="long" value="" ng-model="user_long">
          </div>

            <div class="text-center mb-5">
                <button class="btn btn-submit btn-primary" ng-click="submitHandler()" >Get New Results</button>
            </div>
      </div>


          <div class="btn-row pagination text-center" style="width:100%">
      <li  style="margin:5px; display:inline-block;" ng-repeat="label in labels" idkey="[label.label]" ng-click="tabClick(label.label)">
          <a href="#">[label.label]</a>
      </li>
  </div>
  <div class="mb-5 row">

<div class="col-md-12">
      Multi Select:
    <input type="text" name="lat"  value="" ng-model="multi_select" class="form-control">
    <p>enter comma separated value eg:(1,2,3)</p>
    <div class="text-center">
        <button class="btn btn-primary" ng-click="multiSelect()" >Get MultiSelect Results</button>
    </div>

</div>

  </div>
      </div>

  <!--<button type="button" class="btn btn-primary" data-toggle="modal" data-target="#addrecord">Open Modal</button>-->



  <ui-gmap-google-map center="map.center" zoom="map.zoom" options="map.options">
    <ui-gmap-marker ng-repeat="marker in markers" coords="marker.coords" options="marker.options" events="marker.events" idkey="marker.id">
        <ui-gmap-window>
           <div id="infowindow">
               <b><span style="color:blue">hospital name: </span></b><span>[marker.hospital_name]</span><br>
               <b><span style="color:blue">address: </span></b><span>[marker.address]</span><br>
               <b><span style="color:blue">place id: </span></b><span>[marker.place_id]</span><br>
               <b><span style="color:blue">reason: </span></b><span>[marker.reason]</span><br>
               <b><span style="color:blue">multi speciality: </span></b><span>[marker.multi_speciality]</span><br>
               <b><span style="color:blue">has phone: </span></b><span>[marker.has_phone]</span><br>
               <b><span style="color:blue">lead rank: </span></b><span>[marker.lead_rank]</span><br>
               <b><span style="color:blue">combined rating: </span></b><span>[marker.combined_rating]</span><br>
               <b><span style="color:blue">combined rating count: </span></b><span>[marker.combined_rating_count] </span><br>
               <b><span style="color:blue">is potential: </span></b><span>[marker.is_potential]</span><br>
               <b><span style="color:blue">has booking: </span></b><span>[marker.has_booking]</span><br>
               <b><span style="color:blue">time: </span></b><span>[marker.monday_timing]</span><br>
               <b><span style="color:blue">is bookable: </span></b><span>[marker.is_bookable]</span><br>
               <b><span style="color:blue">phone_number: </span></b><span>[marker.phone_number]</span><br>
                <b><span style="color:blue">hospital_id: </span></b><span>[marker.hospital_id]</span><br>
               <a href=[marker.link] target="_blank">click me</a>

            </div>
        </ui-gmap-window>
    </ui-gmap-marker>
   <ui-gmap-polygon ng-repeat="p in polygons track by p.id" path="p.path" stroke="p.stroke" visible="p.visible"
                 geodesic="p.geodesic" fill="p.fill" fit="false" editable="p.editable" draggable="p.draggable"></ui-gmap-polygon>
  </ui-gmap-google-map>
 </div>
</div>

<!--modal to add a new location-->
<!--<div id="addrecord" class="modal fade" role="dialog">-->
  <!--<div class="modal-dialog">-->

    <!--&lt;!&ndash; Modal content&ndash;&gt;-->
    <!--<div class="modal-content">-->
      <!--<div class="modal-header">-->
        <!--<button type="button" class="close" data-dismiss="modal">&times;</button>-->
        <!--<h4 class="modal-title">New Record</h4>-->
      <!--</div>-->
      <!--<div class="modal-body">-->
        <!--&lt;!&ndash;form to add a new record&ndash;&gt;-->
        <!--<form action="/record/create/"  method="POST" enctype="multipart/form-data"> {% csrf_token %}-->
         <!--<label>Location</label>-->
         <!--<input name="location" id="location" class="form-control">-->
         <!--<label>Text</label>-->
         <!--<textarea name="text" id="text" class="form-control"></textarea>-->

         <!--<br/>-->

         <!--<input type="submit" value="Save" class="btn btn-md btn-primary">-->
        <!--</form>-->
        <!--&lt;!&ndash;end form to add a new record&ndash;&gt;-->
      <!--</div>-->
      <!--<div class="modal-footer">-->
        <!--<button type="button" class="btn btn-default" data-dismiss="modal">Close</button>-->
      <!--</div>-->
    <!--</div>-->

  <!--</div>-->
<!--</div>-->
<!--end modal-->

{% endblock %}