{% extends 'doctor/base.html' %}

{% block content %}
<html>
<head>
    <script src="https://code.jquery.com/jquery-3.4.1.min.js" integrity="sha256-CSXorXvZcTkaix6Yvo6HppcZGetbYMGWSFlBw8HfCJo=" crossorigin="anonymous"></script>
    <script src="https://cdn.datatables.net/1.10.20/js/jquery.dataTables.min.js"></script>
    <script src="https://cdn.datatables.net/1.10.20/js/dataTables.bootstrap.min.js"></script>
    <script src="https://cdn.datatables.net/responsive/2.2.3/js/dataTables.responsive.min.js"></script>
    <script src="https://cdn.datatables.net/responsive/2.2.3/js/responsive.bootstrap.min.js"></script>

    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css" integrity="sha384-BVYiiSIFeK1dGmJRAkycuHAHRg32OmUcww7on3RYdg4Va+PmSTsz/K68vbdEjh4u" crossorigin="anonymous">
    <link href="https://cdn.datatables.net/1.10.20/css/dataTables.bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.datatables.net/responsive/2.2.3/css/responsive.bootstrap.min.css" rel="stylesheet">
</head>

<style>
    #map_wrapper {
        height: 100%;
    }
    #map_canvas {
        width: 100%;
        height: 100%;
    }
    .mb-5{
        margin-bottom:10px;
    }
    .gm-style-iw {
        /*width: 320px;*/
        max-width: 330px !important;
    }
    .gm-style-iw-d {
        max-width: 330px !important;
    }
    .table.markerTable {
        font-size: 10.5px;
    }
</style>

<body>

    <div class="container">

        <form class="form-horizontal">
            <div class="form-group">
                <label class="col-sm-2 control-label">Center Point</label>
                <div class="col-sm-10">
                    <select class="form-control" id="selectCenterPoint">
                        <option value="near_me">Near Me</option>
                    </select>
                </div>
            </div>
            <div class="form-group">
                <label class="col-sm-2 control-label">Lat</label>
                <div class="col-sm-10">
                    <input type="text" class="form-control" id="inputLat" placeholder="28.445721">
                </div>
            </div>
            <div class="form-group">
                <label class="col-sm-2 control-label">Lng</label>
                <div class="col-sm-10">
                    <input type="text" class="form-control" id="inputLng" placeholder="77.033695">
                </div>
            </div>
            <div class="form-group">
                <label class="col-sm-2 control-label">Radius</label>
                <div class="col-sm-10">
                    <input type="number" class="form-control" id="inputRadius" placeholder="2000" min="200">
                </div>
            </div>
            <div class="form-group">
                <label class="col-sm-2 control-label">Clinic Rank</label>
                <div class="col-sm-10 rank-selection">
                    <label class="checkbox-inline">
                        <input type="checkbox" id="rank-1" value="1"> 1
                    </label>
                    <label class="checkbox-inline">
                        <input type="checkbox" id="rank-2" value="2"> 2
                    </label>
                    <label class="checkbox-inline">
                        <input type="checkbox" id="rank-3" value="3"> 3
                    </label>
                    <label class="checkbox-inline">
                        <input type="checkbox" id="rank-4" value="4"> 4
                    </label>
                    <label class="checkbox-inline">
                        <input type="checkbox" id="rank-5" value="5"> 5
                    </label>
                    <label class="checkbox-inline">
                        <input type="checkbox" id="rank-6" value="6"> 6
                    </label>
                </div>
            </div>
            <div class="form-group">
                <label class="col-sm-2 control-label">Has Phlebo</label>
                <div class="col-sm-10 phlebo-selection">
                    <label class="checkbox-inline">
                        <input type="checkbox" id="phlebo-1" value="1"> NA
                    </label>
                    <label class="checkbox-inline">
                        <input type="checkbox" id="phlebo-2" value="2"> Yes
                    </label>
                    <label class="checkbox-inline">
                        <input type="checkbox" id="phlebo-3" value="3"> No
                    </label>
                </div>
            </div>
            <div class="form-group">
                <label class="col-sm-2 control-label">Onboarded</label>
                <div class="col-sm-10 onboarded-selection">
                    <label class="checkbox-inline">
                        <input type="checkbox" id="onboarded-1" value="1"> Null
                    </label>
                    <label class="checkbox-inline">
                        <input type="checkbox" id="onboarded-2" value="2"> Yes
                    </label>
                    <label class="checkbox-inline">
                        <input type="checkbox" id="onboarded-3" value="3"> No
                    </label>
                    <label class="checkbox-inline">
                        <input type="checkbox" id="onboarded-4" value="4"> Maybe
                    </label>
                </div>
            </div>
            <div class="form-group">
                <div class="col-sm-offset-2 col-sm-10">
                    <button type="submit" class="btn btn-primary" id="update_map">Update</button>
                </div>
            </div>
        </form>

        <hr>

        <div id="map_wrapper">
            <div id="map_canvas" class="mapping"></div>
        </div>

        <hr>

        <table class="table polygonMarkersList">
            <thead>
            </thead>
            <tbody>
            </tbody>
        </table>

        <hr>
        <div class="table-responsive">
            <table class="table clinicsList table-striped table-bordered dt-responsive">
                <thead>
                </thead>
                <tbody>
                </tbody>
            </table>
        </div>
    </div>

    <script>
        jQuery(function($) {
            // Asynchronously Load the map API
            var script = document.createElement('script');
            script.src = "//maps.googleapis.com/maps/api/js?sensor=false&callback=initialize&libraries=geometry&key=AIzaSyCxzOncSHC1FRfKCTYCAnjOctzsMjMtxj0";
            document.body.appendChild(script);
        });

        var polygonData = polygonArr = []
        var centerPointData = map_markers = []
        var map
        var markerCnt = {}
        var phlebos = {1: 'NA', 2: 'Yes', 3: 'No'}
        var onboarded = {1: 'Null', 2: 'Yes', 3: 'No', 4: 'Maybe'}
        var clinicsListTable

        $(document).ready(function() {
            $.ajax({
                url: '/api/v1/location/cluster_map_data',
                success: function( data ) {
                    polygon_data = data['polygon_data']
                    center_point_data = data['center_point_data']
                    polygonData = convertJsonStringToObjects(polygon_data)
                    centerPointData = convertJsonStringToObjects(center_point_data)
                    detectLocation()
                    setCenterPointData()
                    setPolygonData()
                    getAndUpdateLocation()
                }
            })
        })

        function initialize() {
            generateMap()
        }

        function setPolygonData() {
            newPolygonKeys = Object.keys(polygonData)
            newPolygonData = Object.values(polygonData)
            polygonArr = []
            for (var i=0; i<newPolygonData.length; i++) {
                newPolygon = new google.maps.Polygon({
                    paths: newPolygonData[i].nodes,
                    strokeColor: newPolygonData[i].color,
                    strokeOpactiy:0.5,
                    storkeWeight:1,
                    fillColor: newPolygonData[i].color,
                    label: newPolygonKeys[i],
                    fillOpacity:0.15
               })
               newPolygon.setMap(map);
               polygonArr.push(newPolygon)
            }
        }

        $(document).on('change', '#selectCenterPoint', function() {
            selected_point = $(this).val()
            if (selected_point == 'near_me') {
                detectLocation()
            } else {
                center_points = centerPointData.center_points[selected_point].points
                setLatLong(center_points.lat, center_points.lng)
            }
        })

        function convertJsonStringToObjects(json_string){
            var new_json = json_string.replace(/([a-zA-Z0-9]+?):/g, '"$1":');
            new_json = new_json.replace(/'/g, '"');
            json_response = JSON.parse(new_json)
            return json_response
        }

        string_parameterize = function (str) {
           return str.trim().toLowerCase().replace(/[^a-zA-Z0-9 -]/, "").replace(/\s/g, "-");
        };

        function setCenterPointData() {
            if (centerPointData.defaults) {
                $('#inputRadius').val(centerPointData.defaults.radius)
                $.each(centerPointData.defaults.clinic_rank, function(index, value) {
                    $("#rank-" + value).prop( "checked", true );
                })
                $.each(centerPointData.defaults.has_phlebo, function(index, value) {
                    $("#phlebo-" + value).prop( "checked", true );
                })
                $.each(centerPointData.defaults.onboarded, function(index, value) {
                    $("#onboarded-" + value).prop( "checked", true );
                })
            }
            if (centerPointData.center_points) {
                $.each(centerPointData.center_points, function( index, value ) {
                    $('#selectCenterPoint').append(new Option(value.name, index))
                })
            }
        }

        function setLatLong(lat, long) {
            $("#inputLat").val(lat)
            $("#inputLng").val(long)
        }

        function getSelectedRank() {
            var selected_rank = []
            $.each($(".rank-selection input[type='checkbox']:checked"), function(){
                selected_rank.push($(this).val());
            });
            return selected_rank
        }

        function getSelectedPhlebo() {
            var selected_phlebo = []
            $.each($(".phlebo-selection input[type='checkbox']:checked"), function(){
                selected_phlebo.push($(this).val());
            });
            return selected_phlebo
        }

        function getSelectedOnboarded() {
            var selected_onboarded = []
            $.each($(".onboarded-selection input[type='checkbox']:checked"), function(){
                selected_onboarded.push($(this).val());
            });
            return selected_onboarded
        }

        function detectLocation() {
            if (navigator.geolocation) {
                navigator.geolocation.getCurrentPosition((position) => {
                    setLatLong(position.coords.latitude, position.coords.longitude)
                    var pos = {
                       lat: position.coords.latitude,
                       lng: position.coords.longitude
                    };
                    //var infoWindow = new google.maps.InfoWindow({
                    //   map: map
                    //});
                    //infoWindow.setPosition(pos);
                    //infoWindow.setContent('<b>You are here.</b>');
                    map.setCenter(pos);
                    var marker = new google.maps.Marker({
                        position: pos,
                        map: map,
                        title: String(pos.lat) + ", " + String(pos.lng),
                        icon:'https://cdn.docprime.com/media/web/custom_images/man-user_1.png'
                    });
                })
            }
        }

        $(document).on('click', '#update_map', function(e) {
            e.preventDefault()
            getAndUpdateLocation()
        })

        function getAndUpdateLocation() {
            lat = $("#inputLat").val()
            lng = $("#inputLng").val()
            radius = $("#inputRadius").val()
            selected_rank = getSelectedRank();
            selected_phlebo = getSelectedPhlebo()
            selected_onboarded = getSelectedOnboarded()

            updateLocationData(lat, lng, radius, selected_rank, selected_phlebo, selected_onboarded)
        }

        function generateMap() {
            var bounds = new google.maps.LatLngBounds();
            var mapOptions = {
                mapTypeId: 'roadmap'
            };
            // Display a map on the page
            map = new google.maps.Map(document.getElementById("map_canvas"), mapOptions);
            map.setTilt(45);
        }

        function updateLocationData(lat=null, lng=null, radius=null, rank=[], phlebo=[], onboarded=[]){
            var url = "/api/v1/doctor/record_api?"
            if (lat && lng){
                url += '&lat='+ lat
                url += '&long='+ lng
            }
            if (radius){
                url += '&radius='+ radius
            }
            if (rank.length) {
                url += '&rank='+ rank
            }
            if (phlebo.length) {
                url += '&phlebo='+ phlebo
            }
            if (onboarded.length) {
                url += '&onboarded='+ onboarded
            }
            $.ajax({
                url: url,
                success: function( data ) {
                    buildMarkers(data.map_data, data.labels)
                    addPolyPoints(polygonArr)
                    addMarkersToClinicList()
                }
            });
        }

        function clearOverlays() {
            for( i = 0; i < map_markers.length; i++ ) {
                map_markers[i].setMap(null)
            }
        }

        function buildMarkers(markers_data, labels){
            clearOverlays()
            markers = markers_data;
            all_labels = labels;
            map_markers = []
            var bounds = new google.maps.LatLngBounds();

            // Display multiple markers on a map
            var infoWindow = new google.maps.InfoWindow({maxWidth: 320}), marker, i;

            // Loop through our array of markers & place each one on the map
            for( i = 0; i < markers.length; i++ ) {
                var position = new google.maps.LatLng(markers[i]['latitude'], markers[i]['longitude']);
                bounds.extend(position);
                marker = new google.maps.Marker({
                    position: position,
                    title: markers[i]['hospital_name'],
                    icon: markers[i]['image'],
                    label: markers[i]['label'],
                    data: {
                            hospital_name: markers[i]['hospital_name'],
                            address: markers[i]['address'],
                            onboarded: onboarded[markers[i]['onboarded']],
                            phone_number: markers[i]['phone_number'],
                            lead_rank: markers[i]['lead_rank'],
                            serial_number: markers[i]['serial_number'],
                            is_bookable: markers[i]['is_bookable'],
                            has_booking: markers[i]['has_booking'],
                            place_id: markers[i]['place_id'],
                            reason: markers[i]['reason'],
                            multi_speciality: markers[i]['multi_speciality'],
                            has_phone: markers[i]['has_phone'],
                            combined_rating: markers[i]['combined_rating'],
                            combined_rating_count: markers[i]['combined_rating_count'],
                            is_potential: markers[i]['is_potential'],
                            monday_timing: markers[i]['monday_timing'],
                            hospital_id: markers[i]['hospital_id'],
                            link: markers[i]['link'],
                            has_phlebo: phlebos[markers[i]['has_phlebo']]
                           }
                });
                marker.setMap(map)
                map_markers.push(marker)

                // Allow each marker to have an info window
                google.maps.event.addListener(marker, 'click', (function(marker, i) {
                    return function() {
                        infoContent = '<table class="table table-condensed markerTable">'

                        $.each(marker.data, function(key, value) {
                            if (key == 'link') {
                                infoContent += '<a class="btn btn-info btn-xs" href='+ marker.data['link'] +' target="_blank">Get Direction</a>'
                            } else {
                                infoContent += '<tr><td>' + key + '</td><td>' + value + '</td></tr>'
                            }
                        })

                        //infoContent = '<a class="btn btn-info btn-xs" href='+ marker.data['link'] +' target="_blank">Get Direction</a><br><b><span style="color:blue">hospital name: </span></b><span>' + marker.data['hospital_name'] + '</span><br><b><span style="color:blue">address: </span></b><span>' + marker.data['address'] +'</span><br><b><span style="color:blue">place id: </span></b><span>'+ marker.data['place_id'] +'</span><br><b><span style="color:blue">reason: </span></b><span>'+ marker.data['reason'] +'</span><br><b><span style="color:blue">multi speciality: </span></b><span>'+ marker.data['multi_speciality'] +'</span><br><b><span style="color:blue">has phone: </span></b><span>'+ marker.data['has_phone'] +'</span><br><b><span style="color:blue">lead rank: </span></b><span>'+ marker.data['lead_rank'] +'</span><br><b><span style="color:blue">combined rating: </span></b><span>'+ marker.data['combined_rating'] +'</span><br><b><span style="color:blue">combined rating count: </span></b><span>'+ marker.data['combined_rating_count'] +'</span><br><b><span style="color:blue">is potential: </span></b><span>'+ marker.data['is_potential'] +'</span><br><b><span style="color:blue">has booking: </span></b><span>'+ marker.data['has_booking'] +'</span><br><b><span style="color:blue">time: </span></b><span>'+ marker.data['monday_timing'] +'</span><br><b><span style="color:blue">is bookable: </span></b><span>'+ marker.data['is_bookable'] +'</span><br><b><span style="color:blue">phone_number: </span></b><span>'+ marker.data['phone_number'] +'</span><br><b><span style="color:blue">hospital_id: </span></b><span>'+ marker.data['hospital_id'] +'</span><br><b><span style="color:blue">has_phlebo: </span></b><span>'+ marker.data['has_phlebo'] +'</span><br><b><span style="color:blue">serial_number: </span></b><span>'+ marker.data['serial_number'] +'</span>'

                        infoContent += '</table>'
                        infoWindow.setContent(infoContent);
                        infoWindow.open(map, marker);
                    }
                })(marker, i));

                // Automatically center the map fitting all markers on the screen
                map.fitBounds(bounds);
            }

            // Override our map zoom level once our fitBounds function runs (Make sure it only runs once)
            var boundsListener = google.maps.event.addListener((map), 'bounds_changed', function(event) {
                this.setZoom(14);
                google.maps.event.removeListener(boundsListener);
            });
        }

        function addPolyPoints(polygonArr) {
            var totalCntInPolygon = []
            var totalCntInLevel = []
            //polyA.push(e.latLng);
            for(var i=0; i < polygonArr.length; i++) {
                markerCnt[i] = {}
                totalCntInPolygon[i] = 0

                for(var j=1; j <= 6; j++) {
                    markerCnt[i][j] = 0
                    totalCntInLevel[j] = 0
                }
            }

            for (var k = 0; k < map_markers.length; k++) {
                for(var i=0; i < polygonArr.length; i++) {
                    if (google.maps.geometry.poly.containsLocation(map_markers[k].getPosition(), polygonArr[i])) {
                        for(var j=1; j <= 6; j++) {
                            if (parseInt(map_markers[k].label) == j) {
                                markerCnt[i][j] = markerCnt[i][j] + 1
                                totalCntInPolygon[i] = totalCntInPolygon[i] + 1
                                totalCntInLevel[j] = totalCntInLevel[j] + 1
                            }
                        }
                    }
                }
            }
            $('.table.polygonMarkersList thead').empty()
            $('.table.polygonMarkersList tbody').empty()
            $('.table.polygonMarkersList thead').append("<tr><th></th></tr><tr><th></th></tr>")

            var markerCntRows = Object.keys(markerCnt).length
            var markerCntColumns = 0
            if (markerCntRows > 0) {
                markerCntColumns = Object.keys(markerCnt[0]).length
                $('.table.polygonMarkersList thead tr').append("<th></th>")
                $('.table.polygonMarkersList thead tr:eq(0) th:eq(1)').text("Total")

                for(var j=1; j<=markerCntColumns; j++) {
                    $('.table.polygonMarkersList thead tr:eq(0)').append("<th>L" + j + "</th>")
                    $('.table.polygonMarkersList thead tr:eq(1) th:eq(1)').text(map_markers.length)
                    $('.table.polygonMarkersList thead tr:eq(1)').append("<td><strong>" + totalCntInLevel[j] + "</strong></td>")
                }
             }

            for(var i=0; i< markerCntRows; i++) {
                $('.table.polygonMarkersList tbody').append("<tr><td style='background-color: " + polygonArr[i].fillColor + ";'>" + polygonArr[i].label + "</td></tr>")
                $('.table.polygonMarkersList tbody tr:eq('+ i +')').append("<td><strong>" + totalCntInPolygon[i] + "</strong></td>")
                for(var j=1; j<= markerCntColumns; j++) {
                    $(".table.polygonMarkersList tbody tr:eq(" + i + ")").append("<td>" + markerCnt[i][j] + "</td>")
                }
            }
        }

        function addMarkersToClinicList() {
            if (clinicsListTable != undefined) {
                clinicsListTable.destroy()
                clinicsListTable = undefined
            }
            $('.table.clinicsList thead').empty()
            $('.table.clinicsList tbody').empty()
            if (map_markers.length) {
                markers_keys = Object.keys(map_markers[0].data)
                $('.table.clinicsList thead').append('<tr></tr>')
                $.each(markers_keys, function(index, value) {
                    $('.table.clinicsList thead tr').append('<th>'+ value +'</th>')
                })
                for (var i = 0; i < map_markers.length; i++) {
                    $('.table.clinicsList tbody').append('<tr></tr>')
                    marker_value = Object.values(map_markers[i].data)
                    $.each(marker_value, function(index, value) {
                        $('.table.clinicsList tbody tr:eq(' + i + ')').append('<td>'+ value +'</td>')
                    })
                }
                clinicsListTable = $('.table.clinicsList').DataTable();
            }
        }
    </script>

</body>


</html>


{% endblock %}